<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>K-Pixel War: ì˜í†  ì „ìŸ</title>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=zx8lobio6s"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: 'Arial', sans-serif; overflow: hidden; }
        #game-container { position: relative; width: 100vw; height: 100vh; }

        /* ì§€ë„ ë ˆì´ì–´ */
        #map { width: 100%; height: 100%; z-index: 1; }

        /* í”½ì…€ ìº”ë²„ìŠ¤ ë ˆì´ì–´ (ì§€ë„ ìœ„ì— íˆ¬ëª…í•˜ê²Œ ê²¹ì¹¨) */
        #pixelCanvas {
            position: absolute; top: 0; left: 0;
            z-index: 2; pointer-events: auto;
        }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .ui-panel {
            position: absolute; top: 20px; right: 20px; z-index: 3;
            background: rgba(255, 255, 255, 0.9); padding: 15px;
            border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* ì‹¤ì‹œê°„ ë‰´ìŠ¤ í”¼ë“œ */
        #news-feed {
            position: absolute; bottom: 20px; left: 20px; z-index: 3;
            width: 300px; max-height: 200px; overflow-y: hidden;
            background: rgba(0, 0, 0, 0.7); color: white;
            padding: 10px; border-radius: 5px; font-size: 12px;
        }
        .news-item { margin: 5px 0; border-bottom: 1px solid #444; padding-bottom: 3px; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="map"></div>
    <canvas id="pixelCanvas"></canvas>

    <div class="ui-panel">
        <h3>ğŸ‡°ğŸ‡· ì˜í†  ì ë ¹ì „</h3>
        ìƒ‰ìƒ: <input type="color" id="colorPicker" value="#ff0000"><br><br>
        ìœ ì €ID: <input type="text" id="userId" value="player1" style="width: 100px;">
        <p style="font-size: 11px; color: #666;">* í´ë¦­í•˜ë©´ í”½ì…€ì´ ë°•í™ë‹ˆë‹¤!</p>
    </div>

    <div id="news-feed">
        <div class="news-item">ğŸ“¢ ì „ìŸì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
    </div>
</div>

<script>
    const canvas = document.getElementById('pixelCanvas');
    const ctx = canvas.getContext('2d');
    const pixelSize = 5; // í”½ì…€ í¬ê¸°

    // í™”ë©´ ê½‰ ì°¨ê²Œ ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì ˆ
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // [1] ë„¤ì´ë²„ ì§€ë„ ì´ˆê¸°í™”
    const map = new naver.maps.Map('map', {
        center: new naver.maps.LatLng(36.3504, 127.3845), // ëŒ€í•œë¯¼êµ­ ì¤‘ì‹¬ (ëŒ€ì „ì¯¤)
        zoom: 8,
        draggable: false, // ìº”ë²„ìŠ¤ ì¢Œí‘œ ë§¤ì¹­ì„ ìœ„í•´ ê³ ì •
        scrollWheel: false,
        disableDoubleClickZoom: true
    });

    // [2] ì´ˆê¸° í”½ì…€ ë¡œë”©
    fetch('/api/pixels')
        .then(res => res.json())
        .then(pixels => {
            pixels.forEach(p => drawPixel(p.x, p.y, p.color));
        });

    // [3] ì›¹ì†Œì¼“ ì—°ê²°
    const socket = new SockJS('/ws-pixel');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, () => {
        console.log("ì‹¤ì‹œê°„ í†µì‹  ì—°ê²° ì„±ê³µ! ğŸš€");
        stompClient.subscribe('/topic/pixel', (msg) => {
            const data = JSON.parse(msg.body);
            drawPixel(data.x, data.y, data.color);
            addNews(data.region || 'ì•¼ìƒ', data.userId);
        });
    });

    // [4] í´ë¦­ ì´ë²¤íŠ¸ (ì„œë²„ ì „ì†¡)
    canvas.addEventListener('mousedown', (e) => {
        const x = Math.floor(e.offsetX / pixelSize);
        const y = Math.floor(e.offsetY / pixelSize);
        const color = document.getElementById('colorPicker').value;
        const userId = document.getElementById('userId').value;

        fetch('/api/pixels', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ x, y, color, userId })
        });
    });

    function drawPixel(x, y, color) {
        ctx.fillStyle = color;
        ctx.globalAlpha = 0.7; // ë°‘ì— ì§€ë„ ì‚´ì§ ë³´ì´ê²Œ
        ctx.fillRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize);
    }

    function addNews(region, userId) {
        const feed = document.getElementById('news-feed');
        const item = document.createElement('div');
        item.className = 'news-item';
        item.innerText = `ğŸ“ [${region}] ${userId}ë‹˜ì´ ê³µê²© ì¤‘!`;
        feed.prepend(item);
        if (feed.children.length > 8) feed.lastChild.remove();
    }
</script>

</body>
</html>