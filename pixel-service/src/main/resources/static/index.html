<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>The Pixel War</title>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=zx8lobio6s"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #f0f0f0; }
        #game-container { position: relative; width: 100vw; height: 100vh; }

        #map { width: 100%; height: 100%; z-index: 1; will-change: transform; }
        #pixelCanvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
        }

        .ui-panel {
            position: absolute; top: 20px; right: 20px; z-index: 100;
            background: rgba(255, 255, 255, 0.95); padding: 15px;
            border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            font-family: 'Noto Sans KR', sans-serif;
            min-width: 200px;
            display: flex; flex-direction: column; gap: 10px;
        }

        .mode-btn { width: 100%; padding: 10px; cursor: pointer; font-weight: bold; border-radius: 5px; transition: 0.2s; border: none; }
        .mode-move { background: #4CAF50; color: white; }
        .mode-attack { background: #f44336; color: white; }

        .btn-kakao {
            display: block; width: 100%; padding: 10px 0;
            background-color: #FEE500; color: #000000;
            text-align: center; text-decoration: none;
            font-weight: bold; border-radius: 5px; font-size: 14px; box-sizing: border-box;
        }
        .btn-logout {
            display: block; width: 100%; padding: 5px 0;
            background-color: #999; color: white;
            text-align: center; text-decoration: none;
            border-radius: 4px; font-size: 12px; margin-top: 5px;
        }

        .attack-cursor { cursor: crosshair !important; }
        #login-area, #user-info { display: none; }
        .user-greeting { font-size: 14px; text-align: center; margin: 0; }
        .user-nickname { color: #2196F3; font-weight: bold; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="map"></div>
    <canvas id="pixelCanvas"></canvas>

    <div class="ui-panel">
        <button id="modeBtn" class="mode-btn mode-move">ğŸ“ ì´ë™ ëª¨ë“œ</button>
        <hr style="width: 100%; border: 0; border-top: 1px solid #eee;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span>ìƒ‰ìƒ:</span>
            <input type="color" id="colorPicker" value="#ff0000" style="cursor: pointer;">
        </div>
        <hr style="width: 100%; border: 0; border-top: 1px solid #eee;">

        <div id="login-area">
            <p style="font-size: 12px; color: #666; text-align: center; margin: 0 0 10px 0;">
                í”½ì…€ì„ ì°ìœ¼ë ¤ë©´<br>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
            </p>
            <a href="/oauth2/authorization/kakao" class="btn-kakao">ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸</a>
        </div>

        <div id="user-info">
            <p class="user-greeting">ë°˜ê°‘ìŠµë‹ˆë‹¤!</p>
            <p class="user-greeting"><span id="nickname-display" class="user-nickname">User</span>ë‹˜</p>
            <a href="/logout" class="btn-logout">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </div>
</div>

<script>
    // --- ì„¤ì • ---
    const GRID_SIZE = 0.0001;
    const MIN_ZOOM = 9;   // ì‚¬ìš©ì ìš”ì²­ ê°’ ìœ ì§€
    const MAX_ZOOM = 17;  // ì‚¬ìš©ì ìš”ì²­ ê°’ ìœ ì§€
    const EPSILON = 0.0000001;

    const KOREA_BOUNDS = new naver.maps.LatLngBounds(
        new naver.maps.LatLng(32.80, 124.60), // ë‚¨ì„œìª½ (ì œì£¼ë„ ì•„ë˜)
        new naver.maps.LatLng(38.55, 132.00)  // ë¶ë™ìª½ (ê³ ì„± í†µì¼ì „ë§ëŒ€ ìœ„)
    );
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    let isAttackMode = false;
    let pixelMap = new Map();
    let myNickname = null;
    let isLoggedIn = false;

    // --- ì§€ë„ ì´ˆê¸°í™” ---
    const map = new naver.maps.Map('map', {
        center: new naver.maps.LatLng(37.3595704, 127.105399),
        zoom: 18,
        minZoom: MIN_ZOOM,
        maxZoom: MAX_ZOOM,

        // ì´ë™ ì œí•œ ì„¤ì •
        maxBounds: KOREA_BOUNDS,

        draggable: true, scrollWheel: true, disableDoubleClickZoom: true, tileTransition: true
    });

    // --- ìº”ë²„ìŠ¤ ì„¤ì • ---
    const canvas = document.getElementById('pixelCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false, needsRedraw = false;

    function scheduleDraw() {
        needsRedraw = true;
        if (!isDrawing) { isDrawing = true; requestAnimationFrame(drawLoop); }
    }

    function drawLoop() {
        if (needsRedraw) { drawPixels(); needsRedraw = false; requestAnimationFrame(drawLoop); }
        else { isDrawing = false; }
    }

    function resizeCanvas() {
        const size = map.getSize();
        if (size.width === 0 || size.height === 0) return;
        canvas.width = size.width;
        canvas.height = size.height;
        scheduleDraw();
    }
    window.addEventListener('resize', resizeCanvas);

    // --- í”½ì…€ ê·¸ë¦¬ê¸° ---
    function drawPixels() {
        const projection = map.getProjection();
        const bounds = map.getBounds();

        if (!bounds || !projection) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const nwLat = bounds.getNE().lat();
        const nwLng = bounds.getSW().lng();
        const tlOffset = projection.fromCoordToOffset(new naver.maps.LatLng(nwLat, nwLng));

        const center = map.getCenter();
        const centerOffset = projection.fromCoordToOffset(center);
        const nextGridOffset = projection.fromCoordToOffset(
            new naver.maps.LatLng(center.lat() + GRID_SIZE, center.lng() + GRID_SIZE)
        );

        let pixelW = Math.abs(nextGridOffset.x - centerOffset.x);
        let pixelH = Math.abs(nextGridOffset.y - centerOffset.y);

        pixelW = Math.max(pixelW, 1);
        pixelH = Math.max(pixelH, 1);

        ctx.beginPath();
        pixelMap.forEach((p) => {
            // í™”ë©´ ì•ˆì— ìˆëŠ” ê²ƒë§Œ ê·¸ë¦¼
            if (bounds.hasLatLng(new naver.maps.LatLng(p.lat, p.lng))) {
                const drawLat = p.lat + GRID_SIZE;
                const drawLng = p.lng;
                const latLng = new naver.maps.LatLng(drawLat, drawLng);

                const pOffset = projection.fromCoordToOffset(latLng);
                const x = pOffset.x - tlOffset.x;
                const y = pOffset.y - tlOffset.y;

                ctx.fillStyle = p.color;
                ctx.fillRect(Math.floor(x), Math.floor(y), Math.ceil(pixelW), Math.ceil(pixelH));
            }
        });
    }

    // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
    naver.maps.Event.addListener(map, 'idle', scheduleDraw);
    naver.maps.Event.addListener(map, 'center_changed', scheduleDraw);
    naver.maps.Event.addListener(map, 'zoom_changed', scheduleDraw);
    naver.maps.Event.addListener(map, 'init', resizeCanvas);

    function updatePixelData(pixel) {
        const key = `${pixel.lat.toFixed(4)},${pixel.lng.toFixed(4)}`;
        pixelMap.set(key, pixel);
        scheduleDraw();
    }

    // --- ë°ì´í„° ë¡œë“œ ---
    fetch('/api/pixels')
        .then(res => res.json())
        .then(data => { if(Array.isArray(data)) data.forEach(p => updatePixelData(p)); })
        .catch(err => console.warn("API Error"));

    const socket = new SockJS('/ws-pixel');
    const stompClient = Stomp.over(socket);
    stompClient.connect({}, () => {
        stompClient.subscribe('/topic/pixel', (msg) => {
            updatePixelData(JSON.parse(msg.body));
        });
    });

    // --- í´ë¦­ ì´ë²¤íŠ¸ (ê²½ê³„ ì²´í¬) ---
    naver.maps.Event.addListener(map, 'click', function(e) {
        if (!isAttackMode) return;
        if (!isLoggedIn) { alert("í”½ì…€ì„ ì°ìœ¼ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!"); return; }

        const rawLat = e.coord.lat();
        const rawLng = e.coord.lng();

        const snapLat = Math.floor((rawLat + EPSILON) * 10000) / 10000;
        const snapLng = Math.floor((rawLng + EPSILON) * 10000) / 10000;

        // [ì¤‘ìš”] í”½ì…€ì„ ì°ìœ¼ë ¤ëŠ” ìœ„ì¹˜ê°€ ë‚¨í•œ ê²½ê³„(38.63ë„ ì´í•˜)ì¸ì§€ í™•ì¸
        if (!KOREA_BOUNDS.hasLatLng(new naver.maps.LatLng(snapLat, snapLng))) {
            alert("ëŒ€í•œë¯¼êµ­ ì˜í†  ë‚´ì—ë§Œ í”½ì…€ì„ ì°ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!");
            return;
        }

        const color = document.getElementById('colorPicker').value;
        const newPixel = { lat: snapLat, lng: snapLng, color: color, userId: myNickname };

        const key = `${snapLat.toFixed(4)},${snapLng.toFixed(4)}`;
        const prevPixel = pixelMap.get(key);
        updatePixelData(newPixel);

        fetch('/api/pixels', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newPixel)
        })
        .then(res => res.text())
        .then(result => {
            if (result !== "SUCCESS" && result !== "ì„±ê³µ") {
                if (prevPixel) updatePixelData(prevPixel);
                else { pixelMap.delete(key); scheduleDraw(); }
                console.warn("ì €ì¥ ì‹¤íŒ¨:", result);
            }
        })
        .catch(err => {
            if (prevPixel) updatePixelData(prevPixel);
            else { pixelMap.delete(key); scheduleDraw(); }
        });
    });

    // --- ëª¨ë“œ ì „í™˜ ë²„íŠ¼ ---
    const modeBtn = document.getElementById('modeBtn');
    const mapDiv = document.getElementById('map');
    modeBtn.addEventListener('click', () => {
        isAttackMode = !isAttackMode;
        if (isAttackMode) {
            modeBtn.innerText = "âš”ï¸ ê³µê²© ëª¨ë“œ";
            modeBtn.className = "mode-btn mode-attack";
            map.setOptions({ draggable: false, scrollWheel: false, disableDoubleClickZoom: true });
            mapDiv.classList.add('attack-cursor');
        } else {
            modeBtn.innerText = "ğŸ“ ì´ë™ ëª¨ë“œ";
            modeBtn.className = "mode-btn mode-move";
            map.setOptions({ draggable: true, scrollWheel: true, disableDoubleClickZoom: true });
            mapDiv.classList.remove('attack-cursor');
        }
    });

    // --- ë¡œê·¸ì¸ í™•ì¸ ---
    fetch('/api/user/me')
        .then(response => {
            if (response.ok) return response.json();
            throw new Error('ë¡œê·¸ì¸ ì•ˆë¨');
        })
        .then(user => {
            isLoggedIn = true;
            myNickname = user.nickname || "User";
            document.getElementById('login-area').style.display = 'none';
            document.getElementById('user-info').style.display = 'block';
            document.getElementById('nickname-display').innerText = myNickname;
        })
        .catch(error => {
            isLoggedIn = false;
            document.getElementById('login-area').style.display = 'block';
            document.getElementById('user-info').style.display = 'none';
        });

    setTimeout(resizeCanvas, 500);
</script>
</body>
</html>