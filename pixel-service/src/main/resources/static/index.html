<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Pixel War</title>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=zx8lobio6s"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root { --glass-bg: rgba(20, 20, 20, 0.6); --glass-border: rgba(255, 255, 255, 0.1); --glass-highlight: rgba(255, 255, 255, 0.15); --primary-color: #FF4500; --accent-color: #00A3FF; --text-color: #ffffff; --gold: #FFD700; --silver: #C0C0C0; --bronze: #CD7F32; }
        body { margin: 0; padding: 0; overflow: hidden; background-color: #1a1a1a; font-family: 'Noto Sans KR', sans-serif; }

        /* Í≤åÏûÑ Ï∫îÎ≤ÑÏä§ Î∞è ÏßÄÎèÑ */
        #game-container { position: relative; width: 100vw; height: 100vh; }
        #map { width: 100%; height: 100%; z-index: 1; outline: none; }
        #pixelCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        #previewCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 11; pointer-events: none; }

        /* Í≥µÌÜµ UI Ïä§ÌÉÄÏùº (Glass Morphism) */
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 0.5px solid var(--glass-border); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); color: var(--text-color); transition: all 0.3s ease; }

        /* Ï¢åÏ∏° ÏÉÅÎã®: Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥ */
        #ui-top-left { position: absolute; top: 20px; left: 20px; z-index: 100; display: flex; flex-direction: column; gap: 8px; padding: 12px 16px; border-radius: 20px; min-width: 140px; }
        .user-badge { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 14px; }
        .user-badge span { color: var(--accent-color); text-shadow: 0 0 10px rgba(0, 163, 255, 0.6); }
        .btn-small { background: rgba(255,255,255,0.08); border: none; color: #ddd; padding: 6px 10px; border-radius: 12px; cursor: pointer; font-size: 11px; text-decoration: none; text-align: center; transition: background 0.2s; }
        .btn-small:hover { background: rgba(255,255,255,0.2); color: #fff; }
        .btn-kakao { background-color: #FEE500; color: #000; font-weight: bold; padding: 8px; border-radius: 12px; text-decoration: none; text-align: center; font-size: 13px; opacity: 0.9; }

        /* Ïö∞Ï∏° ÏÉÅÎã®: Îû≠ÌÇπ */
        #ui-top-right { position: absolute; top: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 5px; padding: 15px; border-radius: 20px; min-width: 180px; }
        .rank-title { font-size: 12px; font-weight: 900; color: #aaa; text-transform: uppercase; margin-bottom: 5px; letter-spacing: 1px; }
        .rank-item { display: flex; justify-content: space-between; align-items: center; font-size: 13px; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .rank-item:last-child { border-bottom: none; }
        .rank-num { font-weight: bold; width: 20px; text-align: center; margin-right: 5px; }
        .rank-1 { color: var(--gold); text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        .rank-2 { color: var(--silver); }
        .rank-3 { color: var(--bronze); }
        .rank-name { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100px; }
        .rank-score { font-weight: bold; color: var(--accent-color); }

        /* Ïø®ÌÉÄÏûÑ Ïò§Î≤ÑÎ†àÏù¥ */
        #ui-cooldown-overlay { position: absolute; top: 30px; left: 50%; transform: translateX(-50%); z-index: 100; display: none; padding: 8px 24px; border-radius: 50px; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(15px); border: 1px solid rgba(255, 69, 0, 0.4); box-shadow: 0 0 25px rgba(255, 69, 0, 0.2); align-items: center; gap: 10px; }
        .timer-text { font-size: 18px; font-weight: 900; color: #FFeb3b; }
        .timer-label { font-size: 11px; color: #ccc; text-transform: uppercase; letter-spacing: 1px; }

        /* ÌïòÎã® Ïª®Ìä∏Î°§ Î∞î */
        #ui-bottom-bar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 8px 12px; border-radius: 100px; width: auto; min-width: 400px; }
        .divider { width: 1px; height: 24px; background: rgba(255,255,255,0.15); margin: 0 4px; }
        .color-container { position: relative; width: 42px; height: 42px; border-radius: 50%; overflow: hidden; border: 1.5px solid rgba(255,255,255,0.4); box-shadow: 0 0 15px rgba(255,255,255,0.1); transition: transform 0.2s; cursor: pointer; }
        .color-container:hover { transform: scale(1.1); border-color: #fff; }
        #colorPicker { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; border: none; padding: 0; margin: 0; cursor: pointer; }
        .btn-main-action { flex-grow: 2; height: 48px; border: none; outline: none; border-radius: 30px; font-weight: 800; font-size: 15px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .mode-move { background: linear-gradient(135deg, rgba(76, 175, 80, 0.6), rgba(46, 125, 50, 0.7)); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.2); border: 1px solid rgba(76, 175, 80, 0.3); }
        .mode-attack { background: linear-gradient(135deg, rgba(255, 69, 0, 0.6), rgba(213, 0, 0, 0.7)); box-shadow: 0 4px 20px rgba(255, 69, 0, 0.3); border: 1px solid rgba(255, 69, 0, 0.3); animation: pulse-red 2s infinite; }
        .btn-main-action:active { transform: scale(0.96); }
        #myLocBtn { flex-grow: 1; height: 48px; padding: 0 16px; border: none; outline: none; border-radius: 30px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); color: #eee; font-weight: 700; font-size: 13px; cursor: pointer; transition: all 0.2s; white-space: nowrap; display: flex; align-items: center; justify-content: center; }
        #myLocBtn:hover { background: rgba(255, 255, 255, 0.15); color: #fff; }
        #cameraLockBtn { width: 42px; height: 42px; border-radius: 50%; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); color: #eee; font-size: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        #cameraLockBtn.active-lock { background: rgba(0, 163, 255, 0.2); border-color: rgba(0, 163, 255, 0.5); color: #00A3FF; }

        /* ÎØ∏ÎãàÎßµ */
        #minimap-container { position: absolute; bottom: 20px; right: 20px; z-index: 100; width: 180px; height: 180px; border-radius: 4px; overflow: hidden; border: 2px solid rgba(200, 200, 200, 0.3); box-shadow: 0 0 20px rgba(0, 0, 0, 0.6); background: #000; }
        #mini-map-view { width: 100%; height: 100%; pointer-events: none; }
        #minimap-camera-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 30px; border: 2px solid #fff; box-shadow: 0 0 0 200px rgba(0, 0, 0, 0.5); z-index: 101; pointer-events: none; }

        /* --- [Ïã†Í∑ú] Ï±ÑÌåÖ UI Ïä§ÌÉÄÏùº --- */
        #ui-chat { position: absolute; bottom: 100px; left: 20px; z-index: 100; width: 320px; height: 240px; border-radius: 15px; display: flex; flex-direction: column; overflow: hidden; transition: transform 0.3s ease, opacity 0.3s ease; }
        #chat-messages { flex-grow: 1; padding: 10px; overflow-y: auto; font-size: 13px; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.3) transparent; }
        #chat-messages::-webkit-scrollbar { width: 4px; }
        #chat-messages::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.3); border-radius: 4px; }
        .msg-item { margin-bottom: 4px; line-height: 1.4; word-break: break-all; }
        .msg-sender { font-weight: bold; color: var(--accent-color); margin-right: 4px; }
        .msg-text { color: #eee; }
        .msg-system { color: #aaa; font-style: italic; font-size: 12px; text-align: center; margin: 5px 0; }

        #chat-input-area { display: flex; padding: 8px; background: rgba(0,0,0,0.2); border-top: 1px solid rgba(255,255,255,0.05); }
        #chatInput { flex-grow: 1; background: rgba(255,255,255,0.1); border: none; border-radius: 6px; padding: 6px 10px; color: white; font-size: 13px; outline: none; }
        #chatInput::placeholder { color: rgba(255,255,255,0.4); }
        #chatSendBtn { margin-left: 6px; background: var(--accent-color); border: none; color: white; border-radius: 6px; padding: 0 12px; font-size: 12px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        #chatSendBtn:hover { opacity: 0.8; }

        #chatToggleBtn { position: absolute; bottom: 100px; left: 20px; z-index: 99; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; display: none; }

        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 69, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0); } }
        .hidden { display: none !important; }
        .attack-cursor { cursor: crosshair !important; }

        /* Î™®Î∞îÏùº Î∞òÏùëÌòï */
        @media (max-width: 600px) {
            #ui-bottom-bar { width: 90%; min-width: unset; bottom: 20px; padding: 6px 10px; }
            .btn-main-action { font-size: 13px; height: 44px; }
            #myLocBtn { font-size: 12px; padding: 0 10px; }
            #minimap-container { width: 120px; height: 120px; bottom: 100px; right: 10px; opacity: 0.8; }
            #ui-top-right { top: 70px; right: 10px; scale: 0.8; transform-origin: top right; }

            /* Î™®Î∞îÏùºÏóêÏÑú Ï±ÑÌåÖÏ∞Ω Ï°∞Ï†ï */
            #ui-chat { width: 250px; height: 180px; bottom: 80px; left: 10px; font-size: 12px; opacity: 0.9; }
            #ui-chat.minimized { opacity: 0; pointer-events: none; transform: translateY(20px); }
            #chatToggleBtn { display: flex; bottom: 90px; left: 10px; }
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="map"></div>
    <canvas id="pixelCanvas"></canvas>
    <canvas id="previewCanvas"></canvas>

    <div id="ui-top-left" class="glass-panel">
        <div id="login-area">
            <div style="font-size: 11px; margin-bottom: 6px; text-align: center; color: #ccc;">Î°úÍ∑∏Ïù∏ ÌïÑÏöî</div>
            <a href="/oauth2/authorization/kakao" class="btn-kakao">Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏</a>
        </div>
        <div id="user-info" class="hidden">
            <div class="user-badge">üëã <span id="nickname-display">User</span></div>
            <a href="/logout" class="btn-small" style="margin-top: 5px; display:block;">Î°úÍ∑∏ÏïÑÏõÉ</a>
        </div>
    </div>

    <div id="ui-top-right" class="glass-panel">
        <div class="rank-title">üèÜ Top Conquerors</div>
        <div id="rank-list">
            <div style="text-align: center; font-size: 12px; color: #666;">Loading...</div>
        </div>
    </div>

    <div id="ui-cooldown-overlay">
        <span class="timer-label">Wait</span>
        <span id="timerText" class="timer-text">0</span>
        <span class="timer-label">sec</span>
    </div>

    <button id="chatToggleBtn" class="glass-panel" title="Ï±ÑÌåÖ Ïó¥Í∏∞/Îã´Í∏∞">üí¨</button>
    <div id="ui-chat" class="glass-panel">
        <div id="chat-messages">
            <div class="msg-system">Ï±ÑÌåÖÎ∞©Ïóê Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§.</div>
        </div>
        <div id="chat-input-area">
            <input type="text" id="chatInput" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†•..." maxlength="50" disabled>
            <button id="chatSendBtn" disabled>Ï†ÑÏÜ°</button>
        </div>
    </div>

    <div id="ui-bottom-bar" class="glass-panel">
        <div class="color-container" title="ÏÉâÏÉÅ Î≥ÄÍ≤Ω"><input type="color" id="colorPicker" value="#FF4500"></div>
        <div class="divider"></div>
        <button id="modeBtn" class="btn-main-action mode-move">üìç Ïù¥Îèô Î™®Îìú</button>
        <div class="divider"></div>
        <button id="cameraLockBtn" class="active-lock" title="ÌôîÎ©¥ Í≥†Ï†ï/Ìï¥Ï†ú">üîí</button>
        <div class="divider"></div>
        <button id="myLocBtn">ÎÇ¥ ÏúÑÏπò</button>
    </div>

    <div id="minimap-container">
        <div id="minimap-camera-box"></div>
        <div id="mini-map-view"></div>
    </div>
</div>

<script>
    // --- ÏÑ§Ï†ï ---
    const GRID_SIZE = 0.0003;
    const COOLDOWN_TIME = 5;
    const MIN_ZOOM = 9;
    const MAX_ZOOM = 17;
    const EPSILON = 0.0000001;
    const EDGE_THRESHOLD = 50;
    const SCROLL_SPEED = 15;
    const KOREA_BOUNDS = new naver.maps.LatLngBounds(
        new naver.maps.LatLng(32.80, 124.60),
        new naver.maps.LatLng(38.55, 132.00)
    );

    // --- ÏÉÅÌÉú Î≥ÄÏàò ---
    let isAttackMode = false;
    let pixelMap = new Map();
    let myNickname = null;
    let isLoggedIn = false;
    let isCooldown = false;
    let cooldownInterval = null;
    let isEdgeScrollEnabled = false;

    // --- ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî ---
    const map = new naver.maps.Map('map', {
        center: new naver.maps.LatLng(37.3595704, 127.105399),
        zoom: 16, minZoom: MIN_ZOOM, maxZoom: MAX_ZOOM, maxBounds: KOREA_BOUNDS,
        draggable: true, scrollWheel: true, disableDoubleClickZoom: true, tileTransition: true,
        logoControl: false, mapDataControl: false, scaleControl: false
    });

    const minimap = new naver.maps.Map('mini-map-view', {
        center: map.getCenter(), zoom: MIN_ZOOM, minZoom: MIN_ZOOM, maxZoom: MIN_ZOOM,
        disableInteraction: true, logoControl: false, mapDataControl: false, scaleControl: false, zoomControl: false, mapTypeControl: false
    });

    naver.maps.Event.addListener(map, 'center_changed', function(center) { minimap.setCenter(center); });

    // --- Îû≠ÌÇπ Î°úÏßÅ ---
    function fetchRanks() {
        fetch('/api/ranks')
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById('rank-list');
                list.innerHTML = '';
                if (data.length === 0) {
                    list.innerHTML = '<div style="text-align:center; font-size:12px; color:#666;">No Data</div>';
                    return;
                }
                data.forEach(r => {
                    const rankClass = r.rank <= 3 ? `rank-${r.rank}` : '';
                    const html = `
                        <div class="rank-item">
                            <span class="rank-num ${rankClass}">${r.rank}</span>
                            <span class="rank-name">${r.nickname}</span>
                            <span class="rank-score">${r.score}</span>
                        </div>
                    `;
                    list.innerHTML += html;
                });
            })
            .catch(console.error);
    }
    setInterval(fetchRanks, 3000);
    fetchRanks();

    // --- ÌôîÎ©¥ Í≥†Ï†ï Î∞è Ïó£ÏßÄ Ïä§ÌÅ¨Î°§ ---
    const cameraLockBtn = document.getElementById('cameraLockBtn');
    cameraLockBtn.addEventListener('click', () => {
        isEdgeScrollEnabled = !isEdgeScrollEnabled;
        if (isEdgeScrollEnabled) {
            map.setOptions({ draggable: false });
            cameraLockBtn.innerText = "üîì";
            cameraLockBtn.classList.remove('active-lock');
        } else {
            map.setOptions({ draggable: true });
            cameraLockBtn.innerText = "üîí";
            cameraLockBtn.classList.add('active-lock');
        }
    });

    let scrollX = 0, scrollY = 0, isScrolling = false;
    document.addEventListener('mousemove', (e) => {
        if (!isEdgeScrollEnabled) return;
        const w = window.innerWidth, h = window.innerHeight;
        const x = e.clientX, y = e.clientY;
        scrollX = 0; scrollY = 0;
        if (x < EDGE_THRESHOLD) scrollX = -SCROLL_SPEED;
        if (x > w - EDGE_THRESHOLD) scrollX = SCROLL_SPEED;
        if (y < EDGE_THRESHOLD) scrollY = -SCROLL_SPEED;
        if (y > h - EDGE_THRESHOLD) scrollY = SCROLL_SPEED;

        if (scrollX !== 0 || scrollY !== 0) { if (!isScrolling) { isScrolling = true; performEdgeScroll(); } }
        else { isScrolling = false; }
    });
    function performEdgeScroll() {
        if (!isScrolling || !isEdgeScrollEnabled) return;
        map.panBy(new naver.maps.Point(scrollX, scrollY));
        requestAnimationFrame(performEdgeScroll);
    }

    // --- Ï∫îÎ≤ÑÏä§ & ÌîΩÏÖÄ ÎìúÎ°úÏûâ ---
    const canvas = document.getElementById('pixelCanvas');
    const ctx = canvas.getContext('2d');
    const previewCanvas = document.getElementById('previewCanvas');
    const previewCtx = previewCanvas.getContext('2d');
    let isDrawing = false, needsRedraw = false;

    function scheduleDraw() { needsRedraw = true; if (!isDrawing) { isDrawing = true; requestAnimationFrame(drawLoop); } }
    function drawLoop() { if (needsRedraw) { drawPixels(); needsRedraw = false; requestAnimationFrame(drawLoop); } else { isDrawing = false; } }

    function resizeCanvas() {
        const size = map.getSize();
        if (size.width === 0 || size.height === 0) return;
        canvas.width = size.width; canvas.height = size.height;
        previewCanvas.width = size.width; previewCanvas.height = size.height;
        scheduleDraw();
    }
    window.addEventListener('resize', resizeCanvas);

    function drawPixels() {
        const projection = map.getProjection(), bounds = map.getBounds();
        if (!bounds || !projection) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const center = map.getCenter();
        const centerOffset = projection.fromCoordToOffset(center);
        const nextGridOffset = projection.fromCoordToOffset(new naver.maps.LatLng(center.lat() + GRID_SIZE, center.lng() + GRID_SIZE));
        let pixelW = Math.max(Math.abs(nextGridOffset.x - centerOffset.x), 3);
        let pixelH = Math.max(Math.abs(nextGridOffset.y - centerOffset.y), 3);
        if (map.getZoom() < 14) { pixelW += 1; pixelH += 1; }
        const tlOffset = projection.fromCoordToOffset(new naver.maps.LatLng(bounds.getNE().lat(), bounds.getSW().lng()));
        ctx.beginPath();
        pixelMap.forEach((p) => {
            if (bounds.hasLatLng(new naver.maps.LatLng(p.lat, p.lng))) {
                const latLng = new naver.maps.LatLng(p.lat + GRID_SIZE, p.lng);
                const pOffset = projection.fromCoordToOffset(latLng);
                ctx.fillStyle = p.color;
                ctx.fillRect(Math.floor(pOffset.x - tlOffset.x), Math.floor(pOffset.y - tlOffset.y), Math.ceil(pixelW), Math.ceil(pixelH));
            }
        });
    }

    naver.maps.Event.addListener(map, 'mousemove', function(e) {
        if (!isAttackMode) { previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height); return; }
        const projection = map.getProjection(), bounds = map.getBounds();
        if (!projection || !bounds) return;
        const snapLat = Math.floor((e.coord.lat() + EPSILON) / GRID_SIZE) * GRID_SIZE;
        const snapLng = Math.floor((e.coord.lng() + EPSILON) / GRID_SIZE) * GRID_SIZE;
        if (!KOREA_BOUNDS.hasLatLng(new naver.maps.LatLng(snapLat, snapLng))) return;
        const center = map.getCenter();
        const centerOffset = projection.fromCoordToOffset(center);
        const nextGridOffset = projection.fromCoordToOffset(new naver.maps.LatLng(center.lat() + GRID_SIZE, center.lng() + GRID_SIZE));
        let pixelW = Math.max(Math.abs(nextGridOffset.x - centerOffset.x), 3);
        let pixelH = Math.max(Math.abs(nextGridOffset.y - centerOffset.y), 3);
        previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
        const latLng = new naver.maps.LatLng(snapLat + GRID_SIZE, snapLng);
        const pOffset = projection.fromCoordToOffset(latLng);
        const tlOffset = projection.fromCoordToOffset(new naver.maps.LatLng(bounds.getNE().lat(), bounds.getSW().lng()));
        const color = document.getElementById('colorPicker').value;
        const r = parseInt(color.substring(1, 3), 16), g = parseInt(color.substring(3, 5), 16), b = parseInt(color.substring(5, 7), 16);
        previewCtx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.5)`;
        previewCtx.strokeStyle = "white"; previewCtx.lineWidth = 1;
        const px = Math.floor(pOffset.x - tlOffset.x), py = Math.floor(pOffset.y - tlOffset.y);
        previewCtx.fillRect(px, py, Math.ceil(pixelW), Math.ceil(pixelH));
        previewCtx.strokeRect(px, py, Math.ceil(pixelW), Math.ceil(pixelH));
    });

    function fetchVisiblePixels() {
        const bounds = map.getBounds();
        if (!bounds) return;
        const sw = bounds.getSW(), ne = bounds.getNE();
        fetch(`/api/pixels?minLat=${sw.lat()}&maxLat=${ne.lat()}&minLng=${sw.lng()}&maxLng=${ne.lng()}`)
            .then(res => res.json())
            .then(data => {
                if (Array.isArray(data)) {
                    data.forEach(p => {
                        const snapLat = (Math.floor((p.lat + EPSILON) / GRID_SIZE) * GRID_SIZE).toFixed(6);
                        const snapLng = (Math.floor((p.lng + EPSILON) / GRID_SIZE) * GRID_SIZE).toFixed(6);
                        pixelMap.set(`${snapLat},${snapLng}`, { ...p, lat: parseFloat(snapLat), lng: parseFloat(snapLng) });
                    });
                    scheduleDraw();
                }
            }).catch(console.warn);
    }
    naver.maps.Event.addListener(map, 'idle', fetchVisiblePixels);
    naver.maps.Event.addListener(map, 'init', fetchVisiblePixels);
    naver.maps.Event.addListener(map, 'center_changed', scheduleDraw);
    naver.maps.Event.addListener(map, 'zoom_changed', scheduleDraw);

    function updatePixelData(pixel) {
        const snapLat = (Math.floor((pixel.lat + EPSILON) / GRID_SIZE) * GRID_SIZE).toFixed(6);
        const snapLng = (Math.floor((pixel.lng + EPSILON) / GRID_SIZE) * GRID_SIZE).toFixed(6);
        pixelMap.set(`${snapLat},${snapLng}`, { ...pixel, lat: parseFloat(snapLat), lng: parseFloat(snapLng) });
        scheduleDraw();
        fetchRanks();
    }

    // --- [ÏàòÏ†ï] WebSocket & Ï±ÑÌåÖ ÌÜµÌï© ---
    const socket = new SockJS('/ws-pixel');
    const stompClient = Stomp.over(socket);
    const roomId = "1"; // Ï±ÑÌåÖÎ∞© ID (Îã®ÏùºÎ∞©)

    stompClient.connect({}, () => {
        // 1. ÌîΩÏÖÄ ÏóÖÎç∞Ïù¥Ìä∏ Íµ¨ÎèÖ (Í≤ΩÎ°ú ÏàòÏ†ï: /topic -> /sub)
        stompClient.subscribe('/sub/pixel', (msg) => updatePixelData(JSON.parse(msg.body)));
        // (ÌòπÏãú Î∞±ÏóîÎìúÍ∞Ä Ïó¨Ï†ÑÌûà /topic/pixelÏùÑ Ïì¥Îã§Î©¥ ÏïÑÎûò Ï§Ñ Ï£ºÏÑù Ìï¥Ï†ú)
        // stompClient.subscribe('/topic/pixel', (msg) => updatePixelData(JSON.parse(msg.body)));

        // 2. Ï±ÑÌåÖ Íµ¨ÎèÖ
        stompClient.subscribe('/sub/chat/room/' + roomId, function (chatMessage) {
            appendChatMessage(JSON.parse(chatMessage.body));
        });

        // 3. ÏûÖÏû• Î©îÏãúÏßÄ (Î°úÍ∑∏Ïù∏ Îêú Í≤ΩÏö∞Îßå)
        if (isLoggedIn && myNickname) {
            sendChatMessage('ENTER', '');
            document.getElementById('chatInput').disabled = false;
            document.getElementById('chatSendBtn').disabled = false;
        }
    });

    // Ï±ÑÌåÖ Î©îÏãúÏßÄ ÌôîÎ©¥ Ï∂îÍ∞Ä Ìï®Ïàò
    function appendChatMessage(message) {
        const chatBox = document.getElementById('chat-messages');
        const msgDiv = document.createElement('div');

        if (message.type === 'ENTER') {
            msgDiv.className = 'msg-system';
            msgDiv.innerText = message.message;
        } else {
            msgDiv.className = 'msg-item';
            msgDiv.innerHTML = `<span class="msg-sender">${message.sender}:</span><span class="msg-text">${message.message}</span>`;
        }

        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Ï±ÑÌåÖ Ï†ÑÏÜ° Ìï®Ïàò
    function sendChatMessage(type, text) {
        if (!stompClient || !isLoggedIn) return;
        stompClient.send("/pub/chat/message", {}, JSON.stringify({
            type: type,
            roomId: roomId,
            sender: myNickname,
            message: text
        }));
    }

    // Ï±ÑÌåÖ UI Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');
    const chatToggleBtn = document.getElementById('chatToggleBtn');
    const chatUi = document.getElementById('ui-chat');

    chatSendBtn.addEventListener('click', () => {
        const msg = chatInput.value;
        if (msg.trim() !== '') {
            sendChatMessage('TALK', msg);
            chatInput.value = '';
        }
    });

    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const msg = chatInput.value;
            if (msg.trim() !== '') {
                sendChatMessage('TALK', msg);
                chatInput.value = '';
            }
        }
    });

    // Î™®Î∞îÏùºÏö© Ï±ÑÌåÖ ÌÜ†Í∏Ä
    chatToggleBtn.addEventListener('click', () => {
        chatUi.classList.toggle('minimized');
    });

    // --- Ïø®ÌÉÄÏûÑ Î∞è ÌÅ¥Î¶≠ Î°úÏßÅ ---
    function startCooldown(seconds) {
        isCooldown = true;
        const display = document.getElementById('ui-cooldown-overlay');
        const timerText = document.getElementById('timerText');
        display.style.display = 'flex';
        document.getElementById('modeBtn').style.opacity = '0.5';
        let remaining = seconds; timerText.innerText = remaining;
        if (cooldownInterval) clearInterval(cooldownInterval);
        cooldownInterval = setInterval(() => {
            remaining--; timerText.innerText = remaining;
            if (remaining <= 0) {
                clearInterval(cooldownInterval);
                isCooldown = false;
                display.style.display = 'none';
                document.getElementById('modeBtn').style.opacity = '1';
            }
        }, 1000);
    }

    naver.maps.Event.addListener(map, 'click', function(e) {
        if (!isAttackMode) return;
        if (!isLoggedIn) { alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§!"); return; }
        if (isCooldown) {
            const hud = document.getElementById('ui-cooldown-overlay');
            hud.style.transform = 'translateX(-50%) scale(1.1)';
            setTimeout(() => hud.style.transform = 'translateX(-50%) scale(1)', 100);
            return;
        }
        const snapLat = Math.floor((e.coord.lat() + EPSILON) / GRID_SIZE) * GRID_SIZE;
        const snapLng = Math.floor((e.coord.lng() + EPSILON) / GRID_SIZE) * GRID_SIZE;
        if (!KOREA_BOUNDS.hasLatLng(new naver.maps.LatLng(snapLat, snapLng))) { alert("ÏÑúÎπÑÏä§ ÏßÄÏó≠Ïù¥ ÏïÑÎãôÎãàÎã§."); return; }
        const color = document.getElementById('colorPicker').value;
        const newPixel = { lat: snapLat, lng: snapLng, color: color, userId: myNickname };
        updatePixelData(newPixel);
        fetch('/api/pixels', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(newPixel) })
        .then(res => res.text()).then(result => {
            if (result === "SUCCESS" || result === "ÏÑ±Í≥µ") { startCooldown(COOLDOWN_TIME); }
            else if (result.includes("Ïø®ÌÉÄÏûÑ")) {
                const remaining = result.match(/\d+/) ? parseInt(result.match(/\d+/)[0]) : 5;
                startCooldown(remaining);
                pixelMap.delete(`${snapLat.toFixed(6)},${snapLng.toFixed(6)}`); scheduleDraw();
            } else { alert(result); pixelMap.delete(`${snapLat.toFixed(6)},${snapLng.toFixed(6)}`); scheduleDraw(); }
        }).catch(err => { console.error(err); pixelMap.delete(`${snapLat.toFixed(6)},${snapLng.toFixed(6)}`); scheduleDraw(); });
    });

    const modeBtn = document.getElementById('modeBtn');
    const myLocBtn = document.getElementById('myLocBtn');
    const mapDiv = document.getElementById('map');

    modeBtn.addEventListener('click', () => {
        isAttackMode = !isAttackMode;
        if (isAttackMode) {
            modeBtn.innerHTML = "‚öîÔ∏è Í≥µÍ≤© Î™®Îìú";
            modeBtn.className = "btn-main-action mode-attack";
            if(isEdgeScrollEnabled) map.setOptions({ draggable: false });
            else map.setOptions({ draggable: true });
            mapDiv.classList.add('attack-cursor');
        } else {
            modeBtn.innerHTML = "üìç Ïù¥Îèô Î™®Îìú";
            modeBtn.className = "btn-main-action mode-move";
            if(isEdgeScrollEnabled) map.setOptions({ draggable: false });
            else map.setOptions({ draggable: true });
            mapDiv.classList.remove('attack-cursor');
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
        }
    });

    myLocBtn.addEventListener('click', () => {
        if (!navigator.geolocation) { alert("ÏúÑÏπò Ï†ïÎ≥¥ ÎØ∏ÏßÄÏõê"); return; }
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const loc = new naver.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
                if (KOREA_BOUNDS.hasLatLng(loc)) { map.setCenter(loc); map.setZoom(16); }
                else alert("ÏÑúÎπÑÏä§ ÏßÄÏó≠ Î∞ñÏûÖÎãàÎã§.");
            },
            () => alert("ÏúÑÏπò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.")
        );
    });

    // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú Î∞è Ï±ÑÌåÖ ÌôúÏÑ±Ìôî
    fetch('/api/user/me').then(res => res.ok ? res.json() : Promise.reject()).then(user => {
        isLoggedIn = true; myNickname = user.nickname || "User";
        document.getElementById('login-area').classList.add('hidden');
        document.getElementById('user-info').classList.remove('hidden');
        document.getElementById('nickname-display').innerText = myNickname;

        // Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ Ïãú Ï±ÑÌåÖ ÏûÖÎ†•Ï∞Ω ÌôúÏÑ±Ìôî Î∞è ÏûÖÏû• Ï≤òÎ¶¨
        document.getElementById('chatInput').disabled = false;
        document.getElementById('chatSendBtn').disabled = false;
        if(stompClient && stompClient.connected) {
            sendChatMessage('ENTER', '');
        }
    }).catch(() => { isLoggedIn = false; document.getElementById('login-area').classList.remove('hidden'); document.getElementById('user-info').classList.add('hidden'); });

    setTimeout(resizeCanvas, 500);
</script>
</body>
</html>