<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Pixel War</title>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=zx8lobio6s"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Ultra Transparent Liquid Glass */
            --glass-bg: rgba(20, 20, 20, 0.3);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.15);
            --primary-color: #FF4500;
            --accent-color: #00A3FF;
            --text-color: #ffffff;
        }

        body { margin: 0; padding: 0; overflow: hidden; background-color: #1a1a1a; font-family: 'Noto Sans KR', sans-serif; }

        #game-container { position: relative; width: 100vw; height: 100vh; }

        /* Main Map */
        #map { width: 100%; height: 100%; z-index: 1; outline: none; }

        /* Canvas Layers */
        #pixelCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        #previewCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 11; pointer-events: none; }

        /* --- UI Components --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border: 0.5px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3), inset 0 0 0 0.5px var(--glass-highlight);
            color: var(--text-color);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* 1. Top Left: User Info */
        #ui-top-left {
            position: absolute; top: 20px; left: 20px; z-index: 100;
            display: flex; flex-direction: column; gap: 8px;
            padding: 12px 16px; border-radius: 20px;
            min-width: 140px;
        }
        .user-badge { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 14px; }
        .user-badge span { color: var(--accent-color); text-shadow: 0 0 10px rgba(0, 163, 255, 0.6); }
        .btn-small {
            background: rgba(255,255,255,0.08); border: none; color: #ddd;
            padding: 6px 10px; border-radius: 12px; cursor: pointer; font-size: 11px;
            text-decoration: none; text-align: center; transition: background 0.2s;
        }
        .btn-small:hover { background: rgba(255,255,255,0.2); color: #fff; }
        .btn-kakao {
            background-color: #FEE500; color: #000; font-weight: bold;
            padding: 8px; border-radius: 12px; text-decoration: none; text-align: center; font-size: 13px;
            opacity: 0.9;
        }

        /* 2. Top Center: Cooldown HUD */
        #ui-cooldown-overlay {
            position: absolute; top: 30px; left: 50%; transform: translateX(-50%); z-index: 100;
            display: none; padding: 8px 24px; border-radius: 50px;
            background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 69, 0, 0.4);
            box-shadow: 0 0 25px rgba(255, 69, 0, 0.2);
            align-items: center; gap: 10px;
        }
        .timer-text { font-size: 18px; font-weight: 900; color: #FFeb3b; }
        .timer-label { font-size: 11px; color: #ccc; text-transform: uppercase; letter-spacing: 1px; }

        /* 3. Bottom Center: Main Dock */
        #ui-bottom-bar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 100;
            display: flex; align-items: center; justify-content: space-between; gap: 12px;
            padding: 8px 12px; border-radius: 100px;
            width: auto; min-width: 400px; /* Î≤ÑÌäº Ï∂îÍ∞ÄÎ°ú ÎÑìÏù¥ Ï¶ùÍ∞Ä */
        }
        .divider { width: 1px; height: 24px; background: rgba(255,255,255,0.15); margin: 0 4px; }

        /* Color Picker */
        .color-container {
            position: relative; width: 42px; height: 42px;
            border-radius: 50%; overflow: hidden;
            border: 1.5px solid rgba(255,255,255,0.4);
            box-shadow: 0 0 15px rgba(255,255,255,0.1);
            transition: transform 0.2s; cursor: pointer;
        }
        .color-container:hover { transform: scale(1.1); border-color: #fff; }
        #colorPicker {
            position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            border: none; padding: 0; margin: 0; cursor: pointer;
        }

        /* Main Mode Button */
        .btn-main-action {
            flex-grow: 2; height: 48px; border: none; outline: none; border-radius: 30px;
            font-weight: 800; font-size: 15px; color: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .mode-move {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.6), rgba(46, 125, 50, 0.7));
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.2); border: 1px solid rgba(76, 175, 80, 0.3);
        }
        .mode-attack {
            background: linear-gradient(135deg, rgba(255, 69, 0, 0.6), rgba(213, 0, 0, 0.7));
            box-shadow: 0 4px 20px rgba(255, 69, 0, 0.3); border: 1px solid rgba(255, 69, 0, 0.3);
            animation: pulse-red 2s infinite;
        }
        .btn-main-action:active { transform: scale(0.96); }

        /* Text Button for "My Location" */
        #myLocBtn {
            flex-grow: 1; height: 48px; padding: 0 16px;
            border: none; outline: none; border-radius: 30px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #eee; font-weight: 700; font-size: 13px;
            cursor: pointer; transition: all 0.2s; white-space: nowrap;
            display: flex; align-items: center; justify-content: center;
        }
        #myLocBtn:hover { background: rgba(255, 255, 255, 0.15); color: #fff; }
        #myLocBtn:active { transform: scale(0.96); }

        /* [NEW] Camera Lock Button */
        #cameraLockBtn {
            width: 42px; height: 42px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #eee; font-size: 18px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s;
        }
        #cameraLockBtn:hover { background: rgba(255, 255, 255, 0.15); transform: rotate(-10deg); }
        #cameraLockBtn.active-lock {
            background: rgba(0, 163, 255, 0.2); border-color: rgba(0, 163, 255, 0.5); color: #00A3FF;
        }

        /* Minimap (Zoom Fixed) */
        #minimap-container {
            position: absolute; bottom: 20px; right: 20px; z-index: 100;
            width: 180px; height: 180px;
            border-radius: 4px; overflow: hidden;
            border: 2px solid rgba(200, 200, 200, 0.3);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
            background: #000;
        }

        #mini-map-view { width: 100%; height: 100%; pointer-events: none; }

        /* Camera Box */
        #minimap-camera-box {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 50px; height: 30px;
            border: 2px solid #fff;
            box-shadow: 0 0 0 200px rgba(0, 0, 0, 0.5);
            z-index: 101; pointer-events: none;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 69, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0); }
        }

        .hidden { display: none !important; }
        .attack-cursor { cursor: crosshair !important; }

        @media (max-width: 600px) {
            #ui-bottom-bar { width: 90%; min-width: unset; bottom: 20px; padding: 6px 10px; }
            .btn-main-action { font-size: 13px; height: 44px; }
            #myLocBtn { font-size: 12px; padding: 0 10px; }
            #minimap-container { width: 120px; height: 120px; bottom: 100px; right: 10px; opacity: 0.8; }
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="map"></div>
    <canvas id="pixelCanvas"></canvas>
    <canvas id="previewCanvas"></canvas>

    <div id="ui-top-left" class="glass-panel">
        <div id="login-area">
            <div style="font-size: 11px; margin-bottom: 6px; text-align: center; color: #ccc;">Î°úÍ∑∏Ïù∏ ÌïÑÏöî</div>
            <a href="/oauth2/authorization/kakao" class="btn-kakao">Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏</a>
        </div>
        <div id="user-info" class="hidden">
            <div class="user-badge">
                üëã <span id="nickname-display">User</span>
            </div>
            <a href="/logout" class="btn-small" style="margin-top: 5px; display:block;">Î°úÍ∑∏ÏïÑÏõÉ</a>
        </div>
    </div>

    <div id="ui-cooldown-overlay">
        <span class="timer-label">Wait</span>
        <span id="timerText" class="timer-text">0</span>
        <span class="timer-label">sec</span>
    </div>

    <div id="ui-bottom-bar" class="glass-panel">
        <div class="color-container" title="ÏÉâÏÉÅ Î≥ÄÍ≤Ω">
            <input type="color" id="colorPicker" value="#FF4500">
        </div>
        <div class="divider"></div>

        <button id="modeBtn" class="btn-main-action mode-move">
            üìç Ïù¥Îèô Î™®Îìú
        </button>

        <div class="divider"></div>

        <button id="cameraLockBtn" title="ÌôîÎ©¥ Í≥†Ï†ï/Ìï¥Ï†ú">
            üîì
        </button>

        <div class="divider"></div>

        <button id="myLocBtn">
            ÎÇ¥ ÏúÑÏπò
        </button>
    </div>

    <div id="minimap-container">
        <div id="minimap-camera-box"></div>
        <div id="mini-map-view"></div>
    </div>

</div>

<script>
    // --- ÏÑ§Ï†ï ---
    const GRID_SIZE = 0.0003;
    const COOLDOWN_TIME = 5;
    const MIN_ZOOM = 9;
    const MAX_ZOOM = 17;
    const EPSILON = 0.0000001;

    // Ïó£ÏßÄ Ïä§ÌÅ¨Î°§ ÏÑ§Ï†ï
    const EDGE_THRESHOLD = 50;
    const SCROLL_SPEED = 15;

    const KOREA_BOUNDS = new naver.maps.LatLngBounds(
        new naver.maps.LatLng(32.80, 124.60),
        new naver.maps.LatLng(38.55, 132.00)
    );

    let isAttackMode = false;
    let pixelMap = new Map();
    let myNickname = null;
    let isLoggedIn = false;
    let isCooldown = false;
    let cooldownInterval = null;

    // [NEW] ÌôîÎ©¥ Í≥†Ï†ï ÏÉÅÌÉú Î≥ÄÏàò (Í∏∞Î≥∏Í∞í: Í≥†Ï†ï Ìï¥Ï†ú = Ïó£ÏßÄ Ïä§ÌÅ¨Î°§ ON)
    let isEdgeScrollEnabled = true;

    // --- ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî (Î©îÏù∏) ---
    const map = new naver.maps.Map('map', {
        center: new naver.maps.LatLng(37.3595704, 127.105399),
        zoom: 16,
        minZoom: MIN_ZOOM,
        maxZoom: MAX_ZOOM,
        maxBounds: KOREA_BOUNDS,
        draggable: false, // Ïó£ÏßÄ Ïä§ÌÅ¨Î°§Ïù¥ Í∏∞Î≥∏Ïù¥ÎØÄÎ°ú ÎìúÎûòÍ∑∏ Í∫ºÎë†
        scrollWheel: true,
        disableDoubleClickZoom: true,
        tileTransition: true,
        logoControl: false, mapDataControl: false, scaleControl: false
    });

    // --- ÎØ∏ÎãàÎßµ Ï¥àÍ∏∞Ìôî (Ï§å Í≥†Ï†ï) ---
    const minimap = new naver.maps.Map('mini-map-view', {
        center: map.getCenter(),
        zoom: MIN_ZOOM,
        minZoom: MIN_ZOOM,
        maxZoom: MIN_ZOOM,
        disableInteraction: true,
        logoControl: false, mapDataControl: false, scaleControl: false,
        zoomControl: false, mapTypeControl: false
    });

    naver.maps.Event.addListener(map, 'center_changed', function(center) {
        minimap.setCenter(center);
    });

    // --- [NEW] ÌôîÎ©¥ Í≥†Ï†ï/Ìï¥Ï†ú Î°úÏßÅ ---
    const cameraLockBtn = document.getElementById('cameraLockBtn');

    cameraLockBtn.addEventListener('click', () => {
        isEdgeScrollEnabled = !isEdgeScrollEnabled;

        if (isEdgeScrollEnabled) {
            // üîì Í≥†Ï†ï Ìï¥Ï†ú (Ïó£ÏßÄ Ïä§ÌÅ¨Î°§ Î™®Îìú)
            map.setOptions({ draggable: false }); // ÎìúÎûòÍ∑∏ ÎÅÑÍ∏∞
            cameraLockBtn.innerText = "üîì";
            cameraLockBtn.classList.remove('active-lock');
        } else {
            // üîí ÌôîÎ©¥ Í≥†Ï†ï (ÎìúÎûòÍ∑∏ Î™®Îìú)
            map.setOptions({ draggable: true }); // ÎìúÎûòÍ∑∏ ÏºúÍ∏∞
            cameraLockBtn.innerText = "üîí";
            cameraLockBtn.classList.add('active-lock');
        }
    });

    // --- Ïó£ÏßÄ Ïä§ÌÅ¨Î°§ Î°úÏßÅ ---
    let scrollX = 0;
    let scrollY = 0;
    let isScrolling = false;

    document.addEventListener('mousemove', (e) => {
        // [CHECK] Í≥†Ï†ï ÏÉÅÌÉúÎ©¥ Ïó£ÏßÄ Ïä§ÌÅ¨Î°§ ÏïàÌï®
        if (!isEdgeScrollEnabled) return;

        const w = window.innerWidth;
        const h = window.innerHeight;
        const x = e.clientX;
        const y = e.clientY;

        scrollX = 0;
        scrollY = 0;

        if (x < EDGE_THRESHOLD) scrollX = -SCROLL_SPEED;
        if (x > w - EDGE_THRESHOLD) scrollX = SCROLL_SPEED;
        if (y < EDGE_THRESHOLD) scrollY = -SCROLL_SPEED;
        if (y > h - EDGE_THRESHOLD) scrollY = SCROLL_SPEED;

        if (scrollX !== 0 || scrollY !== 0) {
            if (!isScrolling) {
                isScrolling = true;
                performEdgeScroll();
            }
        } else {
            isScrolling = false;
        }
    });

    function performEdgeScroll() {
        if (!isScrolling || !isEdgeScrollEnabled) return;
        map.panBy(new naver.maps.Point(scrollX, scrollY));
        requestAnimationFrame(performEdgeScroll);
    }

    // --- Ï∫îÎ≤ÑÏä§ ÏÑ§Ï†ï ---
    const canvas = document.getElementById('pixelCanvas');
    const ctx = canvas.getContext('2d');
    const previewCanvas = document.getElementById('previewCanvas');
    const previewCtx = previewCanvas.getContext('2d');
    let isDrawing = false, needsRedraw = false;

    function scheduleDraw() { needsRedraw = true; if (!isDrawing) { isDrawing = true; requestAnimationFrame(drawLoop); } }
    function drawLoop() { if (needsRedraw) { drawPixels(); needsRedraw = false; requestAnimationFrame(drawLoop); } else { isDrawing = false; } }

    function resizeCanvas() {
        const size = map.getSize();
        if (size.width === 0 || size.height === 0) return;
        canvas.width = size.width; canvas.height = size.height;
        previewCanvas.width = size.width; previewCanvas.height = size.height;
        scheduleDraw();
    }
    window.addEventListener('resize', resizeCanvas);

    // --- ÌîΩÏÖÄ Í∑∏Î¶¨Í∏∞ ---
    function drawPixels() {
        const projection = map.getProjection();
        const bounds = map.getBounds();
        if (!bounds || !projection) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const center = map.getCenter();
        const centerOffset = projection.fromCoordToOffset(center);
        const nextGridOffset = projection.fromCoordToOffset(new naver.maps.LatLng(center.lat() + GRID_SIZE, center.lng() + GRID_SIZE));
        let pixelW = Math.max(Math.abs(nextGridOffset.x - centerOffset.x), 3);
        let pixelH = Math.max(Math.abs(nextGridOffset.y - centerOffset.y), 3);

        if (map.getZoom() < 14) { pixelW += 1; pixelH += 1; }

        const tlOffset = projection.fromCoordToOffset(new naver.maps.LatLng(bounds.getNE().lat(), bounds.getSW().lng()));

        ctx.beginPath();
        pixelMap.forEach((p) => {
            if (bounds.hasLatLng(new naver.maps.LatLng(p.lat, p.lng))) {
                const latLng = new naver.maps.LatLng(p.lat + GRID_SIZE, p.lng);
                const pOffset = projection.fromCoordToOffset(latLng);
                const x = Math.floor(pOffset.x - tlOffset.x);
                const y = Math.floor(pOffset.y - tlOffset.y);

                ctx.fillStyle = p.color;
                ctx.fillRect(x, y, Math.ceil(pixelW), Math.ceil(pixelH));
            }
        });
    }

    // --- ÎßàÏö∞Ïä§ ÎØ∏Î¶¨Î≥¥Í∏∞ ---
    naver.maps.Event.addListener(map, 'mousemove', function(e) {
        if (!isAttackMode) { previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height); return; }
        const projection = map.getProjection();
        const bounds = map.getBounds();
        if (!projection || !bounds) return;

        const snapLat = Math.floor((e.coord.lat() + EPSILON) / GRID_SIZE) * GRID_SIZE;
        const snapLng = Math.floor((e.coord.lng() + EPSILON) / GRID_SIZE) * GRID_SIZE;
        if (!KOREA_BOUNDS.hasLatLng(new naver.maps.LatLng(snapLat, snapLng))) return;

        const center = map.getCenter();
        const centerOffset = projection.fromCoordToOffset(center);
        const nextGridOffset = projection.fromCoordToOffset(new naver.maps.LatLng(center.lat() + GRID_SIZE, center.lng() + GRID_SIZE));
        let pixelW = Math.max(Math.abs(nextGridOffset.x - centerOffset.x), 3);
        let pixelH = Math.max(Math.abs(nextGridOffset.y - centerOffset.y), 3);

        previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
        const latLng = new naver.maps.LatLng(snapLat + GRID_SIZE, snapLng);
        const pOffset = projection.fromCoordToOffset(latLng);
        const tlOffset = projection.fromCoordToOffset(new naver.maps.LatLng(bounds.getNE().lat(), bounds.getSW().lng()));

        const color = document.getElementById('colorPicker').value;
        const r = parseInt(color.substring(1, 3), 16);
        const g = parseInt(color.substring(3, 5), 16);
        const b = parseInt(color.substring(5, 7), 16);
        previewCtx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.5)`;
        previewCtx.strokeStyle = "white"; previewCtx.lineWidth = 1;

        const px = Math.floor(pOffset.x - tlOffset.x);
        const py = Math.floor(pOffset.y - tlOffset.y);

        previewCtx.fillRect(px, py, Math.ceil(pixelW), Math.ceil(pixelH));
        previewCtx.strokeRect(px, py, Math.ceil(pixelW), Math.ceil(pixelH));
    });

    // --- Îç∞Ïù¥ÌÑ∞ Î°úÎìú ---
    function fetchVisiblePixels() {
        const bounds = map.getBounds();
        if (!bounds) return;
        const sw = bounds.getSW();
        const ne = bounds.getNE();
        fetch(`/api/pixels?minLat=${sw.lat()}&maxLat=${ne.lat()}&minLng=${sw.lng()}&maxLng=${ne.lng()}`)
            .then(res => res.json())
            .then(data => {
                if (Array.isArray(data)) {
                    data.forEach(p => {
                        const snapLat = (Math.floor((p.lat + EPSILON) / GRID_SIZE) * GRID_SIZE).toFixed(6);
                        const snapLng = (Math.floor((p.lng + EPSILON) / GRID_SIZE) * GRID_SIZE).toFixed(6);
                        const key = `${snapLat},${snapLng}`;
                        pixelMap.set(key, { ...p, lat: parseFloat(snapLat), lng: parseFloat(snapLng) });
                    });
                    scheduleDraw();
                }
            })
            .catch(err => console.warn("Load Error", err));
    }
    naver.maps.Event.addListener(map, 'idle', fetchVisiblePixels);
    naver.maps.Event.addListener(map, 'init', fetchVisiblePixels);
    naver.maps.Event.addListener(map, 'center_changed', scheduleDraw);
    naver.maps.Event.addListener(map, 'zoom_changed', scheduleDraw);

    function updatePixelData(pixel) {
        const snapLat = (Math.floor((pixel.lat + EPSILON) / GRID_SIZE) * GRID_SIZE).toFixed(6);
        const snapLng = (Math.floor((pixel.lng + EPSILON) / GRID_SIZE) * GRID_SIZE).toFixed(6);
        const key = `${snapLat},${snapLng}`;
        pixelMap.set(key, { ...pixel, lat: parseFloat(snapLat), lng: parseFloat(snapLng) });
        scheduleDraw();
    }

    const socket = new SockJS('/ws-pixel');
    const stompClient = Stomp.over(socket);
    stompClient.connect({}, () => {
        stompClient.subscribe('/topic/pixel', (msg) => updatePixelData(JSON.parse(msg.body)));
    });

    // --- Ïø®ÌÉÄÏûÑ UI Î°úÏßÅ ---
    function startCooldown(seconds) {
        isCooldown = true;
        const display = document.getElementById('ui-cooldown-overlay');
        const timerText = document.getElementById('timerText');

        display.style.display = 'flex';
        document.getElementById('modeBtn').style.opacity = '0.5';

        let remaining = seconds;
        timerText.innerText = remaining;

        if (cooldownInterval) clearInterval(cooldownInterval);

        cooldownInterval = setInterval(() => {
            remaining--;
            timerText.innerText = remaining;

            if (remaining <= 0) {
                clearInterval(cooldownInterval);
                isCooldown = false;
                display.style.display = 'none';
                document.getElementById('modeBtn').style.opacity = '1';
            }
        }, 1000);
    }

    // --- ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ ---
    naver.maps.Event.addListener(map, 'click', function(e) {
        if (!isAttackMode) return;
        if (!isLoggedIn) { alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§!"); return; }
        if (isCooldown) {
            const hud = document.getElementById('ui-cooldown-overlay');
            hud.style.transform = 'translateX(-50%) scale(1.1)';
            setTimeout(() => hud.style.transform = 'translateX(-50%) scale(1)', 100);
            return;
        }

        const snapLat = Math.floor((e.coord.lat() + EPSILON) / GRID_SIZE) * GRID_SIZE;
        const snapLng = Math.floor((e.coord.lng() + EPSILON) / GRID_SIZE) * GRID_SIZE;

        if (!KOREA_BOUNDS.hasLatLng(new naver.maps.LatLng(snapLat, snapLng))) {
            alert("ÏÑúÎπÑÏä§ ÏßÄÏó≠Ïù¥ ÏïÑÎãôÎãàÎã§.");
            return;
        }

        const color = document.getElementById('colorPicker').value;
        const newPixel = { lat: snapLat, lng: snapLng, color: color, userId: myNickname };

        updatePixelData(newPixel);

        fetch('/api/pixels', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newPixel)
        })
        .then(res => res.text())
        .then(result => {
            if (result === "SUCCESS" || result === "ÏÑ±Í≥µ") {
                startCooldown(COOLDOWN_TIME);
            } else if (result.includes("Ïø®ÌÉÄÏûÑ")) {
                const numbers = result.match(/\d+/);
                const remaining = numbers ? parseInt(numbers[0]) : 5;
                startCooldown(remaining);
                const key = `${snapLat.toFixed(6)},${snapLng.toFixed(6)}`;
                pixelMap.delete(key);
                scheduleDraw();
            } else {
                alert(result);
                const key = `${snapLat.toFixed(6)},${snapLng.toFixed(6)}`;
                pixelMap.delete(key);
                scheduleDraw();
            }
        })
        .catch(err => {
            console.error(err);
            const key = `${snapLat.toFixed(6)},${snapLng.toFixed(6)}`;
            pixelMap.delete(key);
            scheduleDraw();
        });
    });

    // --- Î≤ÑÌäº Ïù¥Î≤§Ìä∏ (Dock) ---
    const modeBtn = document.getElementById('modeBtn');
    const myLocBtn = document.getElementById('myLocBtn');
    const mapDiv = document.getElementById('map');

    modeBtn.addEventListener('click', () => {
        isAttackMode = !isAttackMode;
        if (isAttackMode) {
            modeBtn.innerHTML = "‚öîÔ∏è Í≥µÍ≤© Î™®Îìú";
            modeBtn.className = "btn-main-action mode-attack";
            // Ïó£ÏßÄ Ïä§ÌÅ¨Î°§ ÏÉÅÌÉúÎ©¥ draggableÏùÄ Í≥ÑÏÜç falseÏó¨Ïïº Ìï®
            if(isEdgeScrollEnabled) {
                map.setOptions({ draggable: false });
            }
            mapDiv.classList.add('attack-cursor');
        } else {
            modeBtn.innerHTML = "üìç Ïù¥Îèô Î™®Îìú";
            modeBtn.className = "btn-main-action mode-move";
            // Ïù¥Îèô Î™®ÎìúÎùºÎèÑ Í≥†Ï†ï ÏÉÅÌÉúÍ∞Ä ÌíÄÎ†§ÏûàÏñ¥ÏïºÎßå ÎìúÎûòÍ∑∏ Í∞ÄÎä•
            if(!isEdgeScrollEnabled) {
                map.setOptions({ draggable: true });
            }
            mapDiv.classList.remove('attack-cursor');
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
        }
    });

    myLocBtn.addEventListener('click', () => {
        if (!navigator.geolocation) { alert("ÏúÑÏπò Ï†ïÎ≥¥ ÎØ∏ÏßÄÏõê"); return; }
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const loc = new naver.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
                if (KOREA_BOUNDS.hasLatLng(loc)) { map.setCenter(loc); map.setZoom(16); }
                else alert("ÏÑúÎπÑÏä§ ÏßÄÏó≠ Î∞ñÏûÖÎãàÎã§.");
            },
            () => alert("ÏúÑÏπò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.")
        );
    });

    // Î°úÍ∑∏Ïù∏ Ï≤¥ÌÅ¨
    fetch('/api/user/me').then(res => res.ok ? res.json() : Promise.reject()).then(user => {
        isLoggedIn = true; myNickname = user.nickname || "User";
        document.getElementById('login-area').classList.add('hidden');
        document.getElementById('user-info').classList.remove('hidden');
        document.getElementById('nickname-display').innerText = myNickname;
    }).catch(() => {
        isLoggedIn = false;
        document.getElementById('login-area').classList.remove('hidden');
        document.getElementById('user-info').classList.add('hidden');
    });

    setTimeout(resizeCanvas, 500);
</script>
</body>
</html>