<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>The Pixel War</title>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=zx8lobio6s"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f0f0f0;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
            will-change: transform;
        }

        #pixelCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        #previewCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 11;
            pointer-events: none;
        }

        .ui-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            font-family: 'Noto Sans KR', sans-serif;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-common {
            width: 100%;
            padding: 10px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 5px;
            transition: 0.2s;
            border: none;
            font-size: 14px;
        }

        .mode-move {
            background: #4CAF50;
            color: white;
        }

        .mode-attack {
            background: #f44336;
            color: white;
        }

        .btn-location {
            background-color: #2196F3;
            color: white;
        }

        .btn-location:hover {
            background-color: #1976D2;
        }

        .btn-kakao {
            display: block;
            width: 100%;
            padding: 10px 0;
            background-color: #FEE500;
            color: #000000;
            text-align: center;
            text-decoration: none;
            font-weight: bold;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .btn-logout {
            display: block;
            width: 100%;
            padding: 5px 0;
            background-color: #999;
            color: white;
            text-align: center;
            text-decoration: none;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 5px;
        }

        .cooldown-box {
            display: none;
            background-color: #333;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
        }

        .cooldown-timer {
            color: #FFeb3b;
            font-size: 18px;
            margin-left: 5px;
        }

        .attack-cursor {
            cursor: crosshair !important;
        }

        #login-area,
        #user-info {
            display: none;
        }

        .user-greeting {
            font-size: 14px;
            text-align: center;
            margin: 0;
        }

        .user-nickname {
            color: #2196F3;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="map"></div>
    <canvas id="pixelCanvas"></canvas>
    <canvas id="previewCanvas"></canvas>

    <div class="ui-panel">
        <button id="modeBtn" class="btn-common mode-move">üìç Ïù¥Îèô Î™®Îìú</button>
        <button id="myLocBtn" class="btn-common btn-location">üß≠ ÎÇ¥ ÏúÑÏπòÎ°ú</button>

        <div id="cooldownDisplay" class="cooldown-box">
            ‚è≥ ÎåÄÍ∏∞: <span id="timerText" class="cooldown-timer">0</span>Ï¥à
        </div>

        <hr style="width: 100%; border: 0; border-top: 1px solid #eee;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span>ÏÉâÏÉÅ:</span>
            <input type="color" id="colorPicker" value="#ff0000" style="cursor: pointer;">
        </div>
        <hr style="width: 100%; border: 0; border-top: 1px solid #eee;">

        <div id="login-area">
            <p style="font-size: 12px; color: #666; text-align: center; margin: 0 0 10px 0;">
                ÌîΩÏÖÄÏùÑ Ï∞çÏúºÎ†§Î©¥<br>Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.
            </p>
            <a href="/oauth2/authorization/kakao" class="btn-kakao">Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏</a>
        </div>

        <div id="user-info">
            <p class="user-greeting">Î∞òÍ∞ëÏäµÎãàÎã§!</p>
            <p class="user-greeting"><span id="nickname-display" class="user-nickname">User</span>Îãò</p>
            <a href="/logout" class="btn-logout">Î°úÍ∑∏ÏïÑÏõÉ</a>
        </div>
    </div>
</div>

<script>
    // --- ÏÑ§Ï†ï ---
    const GRID_SIZE = 0.0003;
    const COOLDOWN_TIME = 5;
    const MIN_ZOOM = 9;
    const MAX_ZOOM = 17;
    const EPSILON = 0.0000001; // [Ï§ëÏöî] Î∂ÄÎèôÏÜåÏàòÏ†ê Ïò§Ï∞® Î≥¥Ï†ïÍ∞í

    const KOREA_BOUNDS = new naver.maps.LatLngBounds(
        new naver.maps.LatLng(32.80, 124.60),
        new naver.maps.LatLng(38.55, 132.00)
    );

    let isAttackMode = false;
    let pixelMap = new Map();
    let myNickname = null;
    let isLoggedIn = false;
    let isCooldown = false;
    let cooldownInterval = null;

    // --- ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî ---
    const map = new naver.maps.Map('map', {
        center: new naver.maps.LatLng(37.3595704, 127.105399),
        zoom: 16,
        minZoom: MIN_ZOOM,
        maxZoom: MAX_ZOOM,
        maxBounds: KOREA_BOUNDS,
        draggable: true,
        scrollWheel: true,
        disableDoubleClickZoom: true,
        tileTransition: true
    });

    // --- Ï∫îÎ≤ÑÏä§ ÏÑ§Ï†ï ---
    const canvas = document.getElementById('pixelCanvas');
    const ctx = canvas.getContext('2d');
    const previewCanvas = document.getElementById('previewCanvas');
    const previewCtx = previewCanvas.getContext('2d');

    let isDrawing = false,
        needsRedraw = false;

    function scheduleDraw() {
        needsRedraw = true;
        if (!isDrawing) {
            isDrawing = true;
            requestAnimationFrame(drawLoop);
        }
    }

    function drawLoop() {
        if (needsRedraw) {
            drawPixels();
            needsRedraw = false;
            requestAnimationFrame(drawLoop);
        } else {
            isDrawing = false;
        }
    }

    function resizeCanvas() {
        const size = map.getSize();
        if (size.width === 0 || size.height === 0) return;
        canvas.width = size.width;
        canvas.height = size.height;
        previewCanvas.width = size.width;
        previewCanvas.height = size.height;
        scheduleDraw();
    }
    window.addEventListener('resize', resizeCanvas);

    // --- Î©îÏù∏ ÌîΩÏÖÄ Í∑∏Î¶¨Í∏∞ (Ïò§Ï∞® ÏàòÏ†ïÎê®) ---
    function drawPixels() {
        const projection = map.getProjection();
        const bounds = map.getBounds();
        if (!bounds || !projection) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const nwLat = bounds.getNE().lat();
        const nwLng = bounds.getSW().lng();
        const tlOffset = projection.fromCoordToOffset(new naver.maps.LatLng(nwLat, nwLng));
        const center = map.getCenter();
        const centerOffset = projection.fromCoordToOffset(center);
        const nextGridOffset = projection.fromCoordToOffset(new naver.maps.LatLng(center.lat() + GRID_SIZE, center.lng() + GRID_SIZE));

        let pixelW = Math.max(Math.abs(nextGridOffset.x - centerOffset.x), 3);
        let pixelH = Math.max(Math.abs(nextGridOffset.y - centerOffset.y), 3);

        ctx.beginPath();
        const displayMap = new Map();

        pixelMap.forEach((p) => {
            if (bounds.hasLatLng(new naver.maps.LatLng(p.lat, p.lng))) {
                // [ÌïµÏã¨ ÏàòÏ†ï] Ï¢åÌëú Í≥ÑÏÇ∞ Ïãú EPSILON ÎçîÌïòÍ∏∞
                const snapLat = (Math.floor((p.lat + EPSILON) / GRID_SIZE) * GRID_SIZE).toFixed(6);
                const snapLng = (Math.floor((p.lng + EPSILON) / GRID_SIZE) * GRID_SIZE).toFixed(6);
                displayMap.set(`${snapLat},${snapLng}`, {
                    ...p,
                    lat: parseFloat(snapLat),
                    lng: parseFloat(snapLng)
                });
            }
        });

        displayMap.forEach((p) => {
            const latLng = new naver.maps.LatLng(p.lat + GRID_SIZE, p.lng);
            const pOffset = projection.fromCoordToOffset(latLng);
            ctx.fillStyle = p.color;
            ctx.fillRect(Math.floor(pOffset.x - tlOffset.x), Math.floor(pOffset.y - tlOffset.y), Math.ceil(pixelW), Math.ceil(pixelH));
        });
    }

    // --- ÎßàÏö∞Ïä§ ÎØ∏Î¶¨Î≥¥Í∏∞ (Ïò§Ï∞® ÏàòÏ†ïÎê®) ---
    naver.maps.Event.addListener(map, 'mousemove', function(e) {
        if (!isAttackMode) {
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
            return;
        }
        const projection = map.getProjection();
        const bounds = map.getBounds();
        if (!projection || !bounds) return;

        // [ÌïµÏã¨ ÏàòÏ†ï] ÎßàÏö∞Ïä§ Ï¢åÌëú Í≥ÑÏÇ∞ ÏãúÏóêÎèÑ EPSILON ÎçîÌïòÍ∏∞
        const snapLat = Math.floor((e.coord.lat() + EPSILON) / GRID_SIZE) * GRID_SIZE;
        const snapLng = Math.floor((e.coord.lng() + EPSILON) / GRID_SIZE) * GRID_SIZE;

        if (!KOREA_BOUNDS.hasLatLng(new naver.maps.LatLng(snapLat, snapLng))) return;

        const nwLat = bounds.getNE().lat();
        const nwLng = bounds.getSW().lng();
        const tlOffset = projection.fromCoordToOffset(new naver.maps.LatLng(nwLat, nwLng));
        const center = map.getCenter();
        const centerOffset = projection.fromCoordToOffset(center);
        const nextGridOffset = projection.fromCoordToOffset(new naver.maps.LatLng(center.lat() + GRID_SIZE, center.lng() + GRID_SIZE));

        previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
        const latLng = new naver.maps.LatLng(snapLat + GRID_SIZE, snapLng);
        const pOffset = projection.fromCoordToOffset(latLng);

        const selectedColor = document.getElementById('colorPicker').value;
        const r = parseInt(selectedColor.substring(1, 3), 16);
        const g = parseInt(selectedColor.substring(3, 5), 16);
        const b = parseInt(selectedColor.substring(5, 7), 16);
        previewCtx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.5)`;
        previewCtx.strokeStyle = "white";
        previewCtx.lineWidth = 1;

        const px = Math.floor(pOffset.x - tlOffset.x);
        const py = Math.floor(pOffset.y - tlOffset.y);
        const pw = Math.ceil(Math.max(Math.abs(nextGridOffset.x - centerOffset.x), 3));
        const ph = Math.ceil(Math.max(Math.abs(nextGridOffset.y - centerOffset.y), 3));
        previewCtx.fillRect(px, py, pw, ph);
        previewCtx.strokeRect(px, py, pw, ph);
    });

    // --- Îç∞Ïù¥ÌÑ∞ Î°úÎìú ---
    function fetchVisiblePixels() {
        const bounds = map.getBounds();
        if (!bounds) return;
        const sw = bounds.getSW();
        const ne = bounds.getNE();
        fetch(`/api/pixels?minLat=${sw.lat()}&maxLat=${ne.lat()}&minLng=${sw.lng()}&maxLng=${ne.lng()}`)
            .then(res => res.json())
            .then(data => {
                if (Array.isArray(data)) {
                    data.forEach(p => updatePixelData(p));
                    scheduleDraw();
                }
            })
            .catch(err => console.warn("Load Error", err));
    }
    naver.maps.Event.addListener(map, 'idle', fetchVisiblePixels);
    naver.maps.Event.addListener(map, 'init', fetchVisiblePixels);
    naver.maps.Event.addListener(map, 'center_changed', scheduleDraw);
    naver.maps.Event.addListener(map, 'zoom_changed', scheduleDraw);

    function updatePixelData(pixel) {
        const key = `${pixel.lat.toFixed(4)},${pixel.lng.toFixed(4)}`;
        pixelMap.set(key, pixel);
        scheduleDraw();
    }

    const socket = new SockJS('/ws-pixel');
    const stompClient = Stomp.over(socket);
    stompClient.connect({}, () => {
        stompClient.subscribe('/topic/pixel', (msg) => updatePixelData(JSON.parse(msg.body)));
    });

    // --- Ïø®ÌÉÄÏûÑ ÏãúÏûë Ìï®Ïàò ---
    function startCooldown(seconds) {
        isCooldown = true;
        const display = document.getElementById('cooldownDisplay');
        const timerText = document.getElementById('timerText');

        display.style.display = 'block';

        let remaining = seconds;
        timerText.innerText = remaining;

        if (cooldownInterval) clearInterval(cooldownInterval);

        cooldownInterval = setInterval(() => {
            remaining--;
            timerText.innerText = remaining;

            if (remaining <= 0) {
                clearInterval(cooldownInterval);
                isCooldown = false;
                display.style.display = 'none';
            }
        }, 1000);
    }

    // --- ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (Ïò§Ï∞® ÏàòÏ†ïÎê®) ---
    naver.maps.Event.addListener(map, 'click', function(e) {
        if (!isAttackMode) return;
        if (!isLoggedIn) {
            alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§!");
            return;
        }

        if (isCooldown) {
            alert("ÏïÑÏßÅ Ïø®ÌÉÄÏûÑÏûÖÎãàÎã§! Ï°∞Í∏àÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.");
            return;
        }

        const rawLat = e.coord.lat();
        const rawLng = e.coord.lng();

        // [ÌïµÏã¨ ÏàòÏ†ï] ÌÅ¥Î¶≠ Ï¢åÌëú Í≥ÑÏÇ∞ ÏãúÏóêÎèÑ EPSILON ÎçîÌïòÍ∏∞
        const snapLat = Math.floor((rawLat + EPSILON) / GRID_SIZE) * GRID_SIZE;
        const snapLng = Math.floor((rawLng + EPSILON) / GRID_SIZE) * GRID_SIZE;

        if (!KOREA_BOUNDS.hasLatLng(new naver.maps.LatLng(snapLat, snapLng))) {
            alert("ÎåÄÌïúÎØºÍµ≠ ÏòÅÌÜ† ÎÇ¥ÏóêÎßå ÌîΩÏÖÄÏùÑ Ï∞çÏùÑ Ïàò ÏûàÏäµÎãàÎã§!");
            return;
        }

        const color = document.getElementById('colorPicker').value;
        const newPixel = {
            lat: snapLat,
            lng: snapLng,
            color: color,
            userId: myNickname
        };

        updatePixelData(newPixel);

        fetch('/api/pixels', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newPixel)
            })
            .then(res => res.text())
            .then(result => {
                if (result === "SUCCESS" || result === "ÏÑ±Í≥µ") {
                    startCooldown(COOLDOWN_TIME);
                }
                else if (result.includes("Ïø®ÌÉÄÏûÑ")) {
                    const numbers = result.match(/\d+/);
                    const remainingSeconds = numbers ? parseInt(numbers[0]) : 60;

                    startCooldown(remainingSeconds);

                    const mapKey = `${snapLat.toFixed(4)},${snapLng.toFixed(4)}`;
                    pixelMap.delete(mapKey);
                    scheduleDraw();

                    alert(result);
                }
                else {
                    alert(result);
                    const mapKey = `${snapLat.toFixed(4)},${snapLng.toFixed(4)}`;
                    pixelMap.delete(mapKey);
                    scheduleDraw();
                }
            })
            .catch(err => {
                console.error(err);
                const mapKey = `${snapLat.toFixed(4)},${snapLng.toFixed(4)}`;
                pixelMap.delete(mapKey);
                scheduleDraw();
            });
    });

    const modeBtn = document.getElementById('modeBtn');
    const myLocBtn = document.getElementById('myLocBtn');
    const mapDiv = document.getElementById('map');

    modeBtn.addEventListener('click', () => {
        isAttackMode = !isAttackMode;
        if (isAttackMode) {
            modeBtn.innerText = "‚öîÔ∏è Í≥µÍ≤© Î™®Îìú";
            modeBtn.className = "btn-common mode-attack";
            map.setOptions({
                draggable: false,
                scrollWheel: false,
                disableDoubleClickZoom: true
            });
            mapDiv.classList.add('attack-cursor');
        } else {
            modeBtn.innerText = "üìç Ïù¥Îèô Î™®Îìú";
            modeBtn.className = "btn-common mode-move";
            map.setOptions({
                draggable: true,
                scrollWheel: true,
                disableDoubleClickZoom: true
            });
            mapDiv.classList.remove('attack-cursor');
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
        }
    });

    myLocBtn.addEventListener('click', () => {
        if (!navigator.geolocation) {
            alert("ÏúÑÏπò Ï†ïÎ≥¥ ÎØ∏ÏßÄÏõê");
            return;
        }
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const loc = new naver.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
                if (KOREA_BOUNDS.hasLatLng(loc)) {
                    map.setCenter(loc);
                    map.setZoom(16);
                } else alert("ÏÑúÎπÑÏä§ ÏßÄÏó≠ Î∞ñÏûÖÎãàÎã§.");
            },
            () => alert("ÏúÑÏπò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.")
        );
    });

    fetch('/api/user/me').then(res => res.ok ? res.json() : Promise.reject()).then(user => {
        isLoggedIn = true;
        myNickname = user.nickname || "User";
        document.getElementById('login-area').style.display = 'none';
        document.getElementById('user-info').style.display = 'block';
        document.getElementById('nickname-display').innerText = myNickname;
    }).catch(() => {
        isLoggedIn = false;
        document.getElementById('login-area').style.display = 'block';
        document.getElementById('user-info').style.display = 'none';
    });

    setTimeout(resizeCanvas, 500);
</script>
</body>
</html>