<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>K-Pixel War: Reddit r/place ìŠ¤íƒ€ì¼</title>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=zx8lobio6s"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Arial', sans-serif; overflow: hidden; }
        #game-container { position: relative; width: 100vw; height: 100vh; }
        #map { width: 100%; height: 100%; z-index: 1; }
        .ui-panel {
            position: absolute; top: 20px; right: 20px; z-index: 3;
            background: rgba(255, 255, 255, 0.9); padding: 15px;
            border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .mode-btn { width: 100%; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px; margin-bottom: 10px; }
        .mode-move { background: #4CAF50; color: white; }
        .mode-attack { background: #f44336; color: white; }
        .cursor-attack { cursor: crosshair !important; }
        #news-feed { position: absolute; bottom: 20px; left: 20px; z-index: 3; width: 300px; padding: 10px; background: rgba(0,0,0,0.7); color: white; border-radius: 5px; font-size: 12px; }
        .news-item { margin: 5px 0; border-bottom: 1px solid #444; padding-bottom: 3px; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="map"></div>
    <div class="ui-panel">
        <button id="modeBtn" class="mode-btn mode-move">ğŸ“ í˜„ì¬ ëª¨ë“œ: ì´ë™</button>
        <hr>
        <h3>ğŸ‡°ğŸ‡· ì˜í†  ì ë ¹ì „</h3>
        ìƒ‰ìƒ: <input type="color" id="colorPicker" value="#ff0000"><br><br>
        ìœ ì €ID: <input type="text" id="userId" value="player1" style="width: 100px;">
    </div>
    <div id="news-feed"><div class="news-item">ğŸ“¢ ì „ìŸì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!</div></div>
</div>

<script>
    let isAttackMode = false;
    let pixelMap = new Map();

    // ì •ë°€ë„ë¥¼ ë†’ì—¬ì„œ ë” ì„¸ë°€í•œ ê·¸ë¦¼ì´ ê°€ëŠ¥í•˜ê²Œ ì„¤ì • (ì•½ 2m ë‹¨ìœ„)
    const GRID_PRECISION = 50000;

    // [1] ì§€ë„ ì´ˆê¸°í™”: ì¤Œ ì œí•œ ë° ë”ë¸”í´ë¦­ ì¤Œ ë°©ì§€
    const map = new naver.maps.Map('map', {
        center: new naver.maps.LatLng(36.3504, 127.3845),
        zoom: 16,
        minZoom: 10,
        maxZoom: 19, // 19ë ˆë²¨ ì´ìƒ í™•ëŒ€ ë°©ì§€
        draggable: true,
        scrollWheel: true,
        disableDoubleClickZoom: true // ë”ë¸”í´ë¦­ í™•ëŒ€ ì›ì²œ ë´‰ì‡„
    });

    // [2] CanvasOverlay í´ë˜ìŠ¤
    var CanvasOverlay = function(options) {
        this._element = document.createElement('canvas');
        this._ctx = this._element.getContext('2d');
        this.setPosition(options.position);
        this.setMap(options.map || null);
    };
    CanvasOverlay.prototype = new naver.maps.OverlayView();
    CanvasOverlay.prototype.constructor = CanvasOverlay;

    CanvasOverlay.prototype.onAdd = function() {
        var overlayLayer = this.getPanes().overlayLayer;
        this._element.style.position = 'absolute';
        this._element.style.pointerEvents = 'none';
        this._element.style.zIndex = 100;
        overlayLayer.appendChild(this._element);
    };

    CanvasOverlay.prototype.draw = function() {
        if (!this.getMap()) return;
        var map = this.getMap();
        var projection = this.getProjection();
        var bounds = map.getBounds();
        var size = map.getSize();
        var zoom = map.getZoom();

        // [í•µì‹¬] ì¤Œ ë ˆë²¨ì— ë”°ë¼ ì‹œê°ì  í”½ì…€ í¬ê¸° ë™ì  ê³„ì‚°
        // ì¤Œì´ ì»¤ì§ˆìˆ˜ë¡(í™•ëŒ€) í”½ì…€ë„ ì»¤ì§€ê³ , ì‘ì•„ì§ˆìˆ˜ë¡(ì¶•ì†Œ) ê¹¨ì•Œì²˜ëŸ¼ ë³€í•¨
        const currentPixelSize = Math.max(1, Math.pow(2, zoom - 14) * 4);

        this._element.width = size.width;
        this._element.height = size.height;

        var sw = bounds.getSW();
        var ne = bounds.getNE();
        var nw = new naver.maps.LatLng(ne.lat(), sw.lng());
        var overlayProjection = this.getProjection();
        var tlPixel = overlayProjection.fromCoordToOffset(nw);

        this._element.style.left = tlPixel.x + 'px';
        this._element.style.top = tlPixel.y + 'px';

        this._ctx.clearRect(0, 0, this._element.width, this._element.height);

        pixelMap.forEach(p => {
            var coord = new naver.maps.LatLng(p.lat, p.lng);
            var pixelPos = overlayProjection.fromCoordToOffset(coord);

            var x = pixelPos.x - tlPixel.x;
            var y = pixelPos.y - tlPixel.y;

            this._ctx.fillStyle = p.color;
            this._ctx.globalAlpha = 0.9;
            this._ctx.fillRect(x - currentPixelSize/2, y - currentPixelSize/2, currentPixelSize, currentPixelSize);

            // ì¤Œì´ ì–´ëŠ ì •ë„ í™•ëŒ€ë˜ì—ˆì„ ë•Œë§Œ í…Œë‘ë¦¬ë¥¼ ê·¸ë ¤ì„œ ê²©ì ëŠë‚Œ ê°•ì¡°
            if (zoom > 15) {
                this._ctx.strokeStyle = "rgba(0,0,0,0.1)";
                this._ctx.lineWidth = 1;
                this._ctx.strokeRect(x - currentPixelSize/2, y - currentPixelSize/2, currentPixelSize, currentPixelSize);
            }
        });
    };

    CanvasOverlay.prototype.onRemove = function() {
        this._element.parentNode.removeChild(this._element);
    };
    CanvasOverlay.prototype.setPosition = function(position) {
        this._position = position;
        this.draw();
    };

    var canvasOverlay = new CanvasOverlay({
        position: map.getCenter(),
        map: map
    });

    function refreshMap() {
        canvasOverlay.draw();
    }

    // [3] ê²©ì ë§ì¶¤ í•¨ìˆ˜
    function snapToGrid(lat, lng) {
        const snappedLat = Math.round(lat * GRID_PRECISION) / GRID_PRECISION;
        const snappedLng = Math.round(lng * GRID_PRECISION) / GRID_PRECISION;
        return { lat: snappedLat, lng: snappedLng };
    }

    // [4] ë°ì´í„° ì—…ë°ì´íŠ¸ (Map êµ¬ì¡°ë¡œ ë®ì–´ì“°ê¸° ì§€ì›)
    function updatePixelData(pixel) {
        const snapped = snapToGrid(pixel.lat, pixel.lng);
        const key = `${snapped.lat},${snapped.lng}`;
        pixelMap.set(key, { ...pixel, lat: snapped.lat, lng: snapped.lng });
        refreshMap();
    }

    // [5] í´ë¦­ ì´ë²¤íŠ¸
    naver.maps.Event.addListener(map, 'click', function(e) {
        if (!isAttackMode) return;
        const snapped = snapToGrid(e.coord.lat(), e.coord.lng());
        const newPixel = {
            lat: snapped.lat, lng: snapped.lng,
            color: document.getElementById('colorPicker').value,
            userId: document.getElementById('userId').value
        };
        updatePixelData(newPixel);
        fetch('/api/pixels', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newPixel)
        });
    });

    // ì´ˆê¸° ë¡œë”©
    fetch('/api/pixels').then(res => res.json()).then(data => {
        data.forEach(p => updatePixelData(p));
    });

    // ì›¹ì†Œì¼“
    const socket = new SockJS('/ws-pixel');
    const stompClient = Stomp.over(socket);
    stompClient.connect({}, () => {
        stompClient.subscribe('/topic/pixel', (msg) => {
            updatePixelData(JSON.parse(msg.body));
        });
    });

    // [6] ëª¨ë“œ ì „í™˜: ë”ë¸”í´ë¦­ í™•ëŒ€ ë°©ì§€ ì˜µì…˜ ìƒì‹œ ìœ ì§€
    const modeBtn = document.getElementById('modeBtn');
    modeBtn.addEventListener('click', () => {
        isAttackMode = !isAttackMode;
        if (isAttackMode) {
            modeBtn.innerText = "âš”ï¸ í˜„ì¬ ëª¨ë“œ: ê³µê²©";
            modeBtn.className = "mode-btn mode-attack";
            document.getElementById('map').classList.add('cursor-attack');
            map.setOptions({ draggable: false, scrollWheel: false, disableDoubleClickZoom: true });
        } else {
            modeBtn.innerText = "ğŸ“ í˜„ì¬ ëª¨ë“œ: ì´ë™";
            modeBtn.className = "mode-btn mode-move";
            document.getElementById('map').classList.remove('cursor-attack');
            map.setOptions({ draggable: true, scrollWheel: true, disableDoubleClickZoom: true });
        }
    });
</script>
</body>
</html>